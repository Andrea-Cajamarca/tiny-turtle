<!DOCTYPE html>
<meta charset="utf-8">
<title>TinyTurtle Lab</title>
<style>
canvas {
  border: 1px dotted gray;
}

#code {
  display: block;
}
</style>
<a href="https://github.com/toolness/tiny-turtle"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
<h1>TinyTurtle Lab</h1>
<canvas id="canvas" width="200" height="200"></canvas>
<textarea id="code" rows="25" cols="50">function box(length) {
  for (var i = 0; i < 4; i++) {
    forward(length);
    right(90);
  }
}

penStyle = 'purple';
box(90);
left(10);
box(80);
left(10);
box(70);
</textarea>
<script src="tiny-turtle.js"></script>
<script>
var $ = document.querySelector.bind(document);
var worker;
var source;
var renderTimeout;
var code = $("#code");
var canvas = $("#canvas");

function queueRendering() {
  clearTimeout(renderTimeout);
  renderTimeout = setTimeout(render, 100);
}

function render() {
  var lines = [];
  var drawLines = function() {
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    lines.forEach(function(line) {
      TinyTurtle.drawLine.apply(TinyTurtle, [canvas].concat(line));
    });
  }

  if (code.value == source) return;
  source = code.value;
  if (worker) worker.terminate();
  worker = new Worker("index.worker.js");
  worker.onmessage = function(e) {
    var data = e.data;
    if (data.msg == 'line')
      lines.push(data.args)
    else if (data.msg == 'done')
      drawLines();
  };
  worker.onerror = function(e) {
    if (lines.length) drawLines();
    // An error will already be logged to the console by the browser.
  };
  worker.postMessage({
    source: code.value,
    height: canvas.height,
    width: canvas.width
  });
  setTimeout(worker.terminate.bind(worker), 5000);
}

render();
code.onkeyup = code.onchange = queueRendering;
</script>
